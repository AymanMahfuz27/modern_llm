"""Visualize LM training results with loss/perplexity curves.

Reads the CSV generated by evaluate_lm_checkpoints.py and creates plots.
"""

from __future__ import annotations

import argparse
import csv
from pathlib import Path

import matplotlib.pyplot as plt


def main() -> None:
    """Plot loss and perplexity curves from LM checkpoint metrics."""

    parser = argparse.ArgumentParser(description="Visualize LM checkpoint metrics.")
    parser.add_argument(
        "--metrics_csv",
        type=str,
        default="experiments/lm_checkpoint_metrics.csv",
        help="Path to CSV with checkpoint metrics",
    )
    parser.add_argument(
        "--output_dir",
        type=str,
        default="experiments/plots",
        help="Directory to save plots",
    )
    args = parser.parse_args()

    csv_path = Path(args.metrics_csv)
    if not csv_path.exists():
        raise FileNotFoundError(f"Metrics CSV not found: {csv_path}")

    output_dir = Path(args.output_dir)
    output_dir.mkdir(parents=True, exist_ok=True)

    data = {}
    with csv_path.open("r") as f:
        reader = csv.DictReader(f)
        for row in reader:
            run = row["run_name"]
            if run not in data:
                data[run] = {"steps": [], "loss": [], "ppl": []}
            data[run]["steps"].append(int(row["global_step"]))
            data[run]["loss"].append(float(row["val_loss"]))
            data[run]["ppl"].append(float(row["val_perplexity"]))

    if not data:
        print("No data to plot.")
        return

    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 5))

    for run_name, metrics in data.items():
        ax1.plot(metrics["steps"], metrics["loss"], marker="o", label=run_name)
        ax2.plot(metrics["steps"], metrics["ppl"], marker="o", label=run_name)

    ax1.set_xlabel("Training Step")
    ax1.set_ylabel("Validation Loss")
    ax1.set_title("Validation Loss vs. Training Step")
    ax1.legend()
    ax1.grid(True, alpha=0.3)

    ax2.set_xlabel("Training Step")
    ax2.set_ylabel("Validation Perplexity")
    ax2.set_title("Validation Perplexity vs. Training Step")
    ax2.legend()
    ax2.grid(True, alpha=0.3)

    plot_path = output_dir / "lm_metrics.png"
    plt.tight_layout()
    plt.savefig(plot_path, dpi=150)
    print(f"Saved plot to {plot_path}")
    plt.close()


if __name__ == "__main__":
    main()



